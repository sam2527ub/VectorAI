<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Agent Chat Interface</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: #0F0F0F;
            color: #ECECEC;
            height: 100vh;
            display: flex;
        }

        /* Sidebar */
        .sidebar {
            width: 260px;
            background: #171717;
            border-right: 1px solid #2F2F2F;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #2F2F2F;
        }

        .new-chat-btn {
            width: 100%;
            padding: 12px;
            background: #10A37F;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }

        .new-chat-btn:hover {
            background: #0D8B6F;
        }

        .chat-sessions {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .chat-session {
            padding: 12px;
            margin-bottom: 8px;
            background: #2A2A2A;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
            border-left: 3px solid transparent;
        }

        .chat-session:hover {
            background: #3A3A3A;
        }

        .chat-session.active {
            background: #3A3A3A;
            border-left-color: #10A37F;
        }

        .session-title {
            font-weight: 500;
            margin-bottom: 4px;
            font-size: 14px;
        }

        .session-preview {
            font-size: 12px;
            color: #8E8E8E;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* Main Chat Area */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            padding: 16px 24px;
            border-bottom: 1px solid #2F2F2F;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .chat-title {
            font-size: 18px;
            font-weight: 600;
        }

        /* Mode Selector */
        .mode-selector {
            display: flex;
            background: #2A2A2A;
            border-radius: 8px;
            padding: 4px;
        }

        .mode-btn {
            padding: 8px 16px;
            background: transparent;
            color: #8E8E8E;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }

        .mode-btn.active {
            background: #10A37F;
            color: white;
        }

        .mode-btn:hover:not(.active) {
            color: #ECECEC;
            background: #3A3A3A;
        }

        /* Chat Messages */
        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .message {
            display: flex;
            gap: 12px;
            max-width: 100%;
        }

        .message.user {
            justify-content: flex-end;
        }

        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
            flex-shrink: 0;
        }

        .avatar-user {
            background: #10A37F;
            color: white;
        }

        .avatar-therapist {
            background: #FF6B6B;
            color: white;
        }

        .avatar-expert {
            background: #4ECDC4;
            color: white;
        }

        .avatar-wise {
            background: #45B7D1;
            color: white;
        }

        .message-content {
            max-width: 70%;
            background: #2A2A2A;
            padding: 16px;
            border-radius: 12px;
            position: relative;
        }

        .message.user .message-content {
            background: #10A37F;
        }

        .agent-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid #404040;
        }

        .agent-name {
            font-weight: 600;
            font-size: 14px;
        }

        .agent-inspiration {
            font-size: 12px;
            color: #8E8E8E;
        }

        .message-text {
            line-height: 1.6;
            white-space: pre-wrap;
        }

        /* Citation and Reasoning Links */
        .metadata-links {
            display: flex;
            gap: 12px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #404040;
        }

        .metadata-link {
            color: #10A37F;
            text-decoration: none;
            font-size: 12px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .metadata-link:hover {
            background: #2A2A2A;
        }

        /* Collapsible sections */
        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            background: #1A1A1A;
            border-radius: 6px;
            margin-top: 8px;
            border: 1px solid #333;
        }

        .collapsible-content.expanded {
            max-height: 400px;
            overflow-y: auto;
            padding: 12px;
        }

        .collapsible-text {
            font-size: 12px;
            line-height: 1.5;
            color: #CCCCCC;
            white-space: pre-wrap;
            margin: 0;
        }

        /* Input Area */
        .input-container {
            padding: 24px;
            border-top: 1px solid #2F2F2F;
        }

        .input-wrapper {
            display: flex;
            gap: 12px;
            align-items: flex-end;
            max-width: 800px;
            margin: 0 auto;
        }

        .message-input {
            flex: 1;
            background: #2A2A2A;
            border: 1px solid #404040;
            border-radius: 12px;
            padding: 12px 16px;
            color: #ECECEC;
            font-size: 14px;
            resize: none;
            min-height: 48px;
            max-height: 120px;
            font-family: inherit;
        }

        .message-input:focus {
            outline: none;
            border-color: #10A37F;
        }

        .send-btn {
            background: #10A37F;
            color: white;
            border: none;
            border-radius: 12px;
            width: 48px;
            height: 48px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .send-btn:hover:not(:disabled) {
            background: #0D8B6F;
        }

        .send-btn:disabled {
            background: #404040;
            cursor: not-allowed;
        }

        /* Typing indicator */
        .typing-indicator {
            display: flex;
            gap: 12px;
            align-items: center;
            padding: 16px 24px;
            background: #2A2A2A;
            margin: 0 24px;
            border-radius: 12px;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }

        .typing-dots {
            display: flex;
            gap: 4px;
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            background: #8E8E8E;
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }

        /* Inter-agent conversation styles */
        .inter-agent-conversation {
            background: #1A1A1A;
            border: 1px solid #404040;
            border-radius: 12px;
            margin: 16px 0;
            padding: 16px;
        }

        .conversation-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
            font-weight: 600;
            color: #10A37F;
            font-size: 14px;
        }

        .agent-conversation-message {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
            padding: 8px;
            background: #252525;
            border-radius: 6px;
        }

        .conversation-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            flex-shrink: 0;
        }

        .conversation-content {
            flex: 1;
            font-size: 13px;
            line-height: 1.5;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                position: absolute;
                z-index: 100;
                transform: translateX(-100%);
                transition: transform 0.3s;
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .main-content {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <button class="new-chat-btn" onclick="createNewSession()">
                <span>‚ûï</span> New Chat
            </button>
        </div>
        <div class="chat-sessions" id="chatSessions">
            <!-- Sessions will be loaded here -->
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Chat Header -->
        <div class="chat-header">
            <div class="chat-title">Multi-Agent Assistant</div>
            <div class="mode-selector">
                <button class="mode-btn active" data-mode="auto">Auto</button>
                <button class="mode-btn" data-mode="therapist">üòä Therapist</button>
                <button class="mode-btn" data-mode="expert">üéì Expert</button>
                <button class="mode-btn" data-mode="wise">üß† Wise</button>
                <button class="mode-btn" data-mode="collaborative">ü§ù All</button>
            </div>
        </div>

        <!-- Chat Container -->
        <div class="chat-container" id="chatContainer">
            <div class="message">
                <div class="message-avatar avatar-wise">üé≠</div>
                <div class="message-content">
                    <div class="message-text">Welcome! I'm your multi-agent assistant. You can ask me anything and I'll automatically route your question to the most suitable agent, or you can manually select who you'd like to talk to using the mode selector above.

‚Ä¢ üòä **Therapist**: Emotional support and mental well-being
‚Ä¢ üéì **Expert**: Practical solutions and step-by-step guidance  
‚Ä¢ üß† **Wise Mentor**: Life wisdom and philosophical perspective
‚Ä¢ ü§ù **Collaborative**: All agents work together

How can we help you today?</div>
                </div>
            </div>
        </div>

        <!-- Typing Indicator -->
        <div class="typing-indicator" id="typingIndicator" style="display: none;">
            <div class="typing-dots">
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            </div>
            <span id="typingText">Agents are thinking...</span>
        </div>

        <!-- Input Container -->
        <div class="input-container">
            <div class="input-wrapper">
                <textarea 
                    class="message-input" 
                    id="messageInput" 
                    placeholder="Message the agents..."
                    rows="1"
                ></textarea>
                <button class="send-btn" id="sendBtn" onclick="sendMessage()">
                    <span>‚û§</span>
                </button>
            </div>
        </div>
    </div>

    <script>
        // Socket.IO connection
        const socket = io();
        
        // Global state
        let currentSessionId = null;
        let currentMode = 'auto';
        let sessions = [];

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadSessions();
            setupEventListeners();
        });

        function setupEventListeners() {
            // Mode selector
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelector('.mode-btn.active').classList.remove('active');
                    this.classList.add('active');
                    currentMode = this.dataset.mode;
                });
            });

            // Enter key to send message
            document.getElementById('messageInput').addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // Auto-resize textarea
            document.getElementById('messageInput').addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 120) + 'px';
            });
        }

        // Session management
        async function loadSessions() {
            try {
                const response = await fetch('/api/sessions');
                sessions = await response.json();
                renderSessions();
                
                if (sessions.length === 0) {
                    createNewSession();
                } else {
                    selectSession(sessions[0].id);
                }
            } catch (error) {
                console.error('Error loading sessions:', error);
            }
        }

        function renderSessions() {
            const container = document.getElementById('chatSessions');
            container.innerHTML = '';
            
            sessions.forEach(session => {
                const sessionEl = document.createElement('div');
                sessionEl.className = 'chat-session';
                sessionEl.onclick = () => selectSession(session.id);
                
                if (session.id === currentSessionId) {
                    sessionEl.classList.add('active');
                }
                
                sessionEl.innerHTML = `
                    <div class="session-title">${session.title}</div>
                    <div class="session-preview">${session.last_message || 'New conversation'}</div>
                `;
                
                container.appendChild(sessionEl);
            });
        }

        async function createNewSession() {
            try {
                const response = await fetch('/api/sessions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await response.json();
                
                await loadSessions();
                selectSession(data.session_id);
            } catch (error) {
                console.error('Error creating session:', error);
            }
        }

        async function selectSession(sessionId) {
            currentSessionId = sessionId;
            renderSessions();
            await loadSessionMessages(sessionId);
        }

        async function loadSessionMessages(sessionId) {
            try {
                const response = await fetch(`/api/sessions/${sessionId}/messages`);
                const messages = await response.json();
                
                const container = document.getElementById('chatContainer');
                // Clear existing messages except welcome message
                const welcomeMsg = container.firstElementChild;
                container.innerHTML = '';
                container.appendChild(welcomeMsg);
                
                messages.forEach(message => {
                    renderMessage(message);
                });
                
                scrollToBottom();
            } catch (error) {
                console.error('Error loading messages:', error);
            }
        }

        // Message handling
        function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message || !currentSessionId) return;
            
            // Clear input
            input.value = '';
            input.style.height = 'auto';
            
            // Disable send button
            document.getElementById('sendBtn').disabled = true;
            
            // Send message via socket
            socket.emit('send_message', {
                session_id: currentSessionId,
                message: message,
                mode: currentMode
            });
        }

        function renderMessage(message) {
            const container = document.getElementById('chatContainer');
            const messageEl = document.createElement('div');
            
            if (message.role === 'user') {
                messageEl.className = 'message user';
                messageEl.innerHTML = `
                    <div class="message-content">
                        <div class="message-text">${escapeHtml(message.content)}</div>
                    </div>
                    <div class="message-avatar avatar-user">U</div>
                `;
            } else {
                // Agent message
                const agentInfo = getAgentInfo(message.agent_type);
                messageEl.className = 'message';
                
                let metadataLinks = '';
                if (message.citation || message.reasoning || message.attribution || message.source_inspiration) {
                    const messageId = Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                    metadataLinks = `
                        <div class="metadata-links">
                            ${message.citation ? `<a class="metadata-link" onclick="toggleCollapsible(this, 'citation-${messageId}')">üìö Citation</a>` : ''}
                            ${message.reasoning ? `<a class="metadata-link" onclick="toggleCollapsible(this, 'reasoning-${messageId}')">üí≠ Reasoning</a>` : ''}
                            ${message.attribution ? `<a class="metadata-link" onclick="toggleCollapsible(this, 'attribution-${messageId}')">üîó Attribution</a>` : ''}
                            ${message.source_inspiration ? `<a class="metadata-link" onclick="toggleCollapsible(this, 'source-${messageId}')">üé¨ Source</a>` : ''}
                        </div>
                        ${message.citation ? `<div class="collapsible-content" data-type="citation-${messageId}"><div class="collapsible-text">${escapeHtml(message.citation)}</div></div>` : ''}
                        ${message.reasoning ? `<div class="collapsible-content" data-type="reasoning-${messageId}"><div class="collapsible-text">${escapeHtml(message.reasoning)}</div></div>` : ''}
                        ${message.attribution ? `<div class="collapsible-content" data-type="attribution-${messageId}"><div class="collapsible-text">${escapeHtml(message.attribution)}</div></div>` : ''}
                        ${message.source_inspiration ? `<div class="collapsible-content" data-type="source-${messageId}"><div class="collapsible-text">${escapeHtml(message.source_inspiration)}</div></div>` : ''}
                    `;
                }
                
                messageEl.innerHTML = `
                    <div class="message-avatar ${agentInfo.avatarClass}">${agentInfo.emoji}</div>
                    <div class="message-content">
                        <div class="agent-header">
                            <span class="agent-name">${agentInfo.name}</span>
                            ${message.inspiration ? `<span class="agent-inspiration">inspired by ${message.inspiration}</span>` : ''}
                        </div>
                        <div class="message-text">${escapeHtml(message.content)}</div>
                        ${metadataLinks}
                    </div>
                `;
            }
            
            container.appendChild(messageEl);
            scrollToBottom();
        }

        function addInterAgentConversation(conversation) {
            const container = document.getElementById('chatContainer');
            const conversationEl = document.createElement('div');
            conversationEl.className = 'inter-agent-conversation';
            
            const agentAvatars = {
                'supportive_friend': { emoji: 'ü§ó', class: 'supportive' },
                'optimistic_friend': { emoji: 'üåü', class: 'optimistic' },
                'wise_mentor': { emoji: 'ü¶â', class: 'wise' },
                'funny_friend': { emoji: 'üòÑ', class: 'funny' },
                'spiritual_guide': { emoji: 'üßò', class: 'spiritual' }
            };
            
            let conversationHtml = `
                <div class="conversation-header">
                    üí¨ Agent Discussion
                </div>
            `;
            
            conversation.forEach(msg => {
                const agentInfo = agentAvatars[msg.agent] || { emoji: 'ü§ñ', class: 'default' };
                conversationHtml += `
                    <div class="agent-conversation-message">
                        <div class="conversation-avatar ${agentInfo.class}">${agentInfo.emoji}</div>
                        <div class="conversation-content">
                            <strong>${msg.agent.replace('_', ' ')}:</strong> ${escapeHtml(msg.content)}
                        </div>
                    </div>
                `;
            });
            
            conversationEl.innerHTML = conversationHtml;
            container.appendChild(conversationEl);
            scrollToBottom();
        }

        function getAgentInfo(agentType) {
            const agentMap = {
                'therapist': { name: 'Therapist', emoji: 'üòä', avatarClass: 'avatar-therapist' },
                'intelligent_expert': { name: 'Expert', emoji: 'üéì', avatarClass: 'avatar-expert' },
                'wise_mentor': { name: 'Wise Mentor', emoji: 'üß†', avatarClass: 'avatar-wise' }
            };
            
            return agentMap[agentType] || { name: 'Agent', emoji: 'ü§ñ', avatarClass: 'avatar-user' };
        }

        function toggleCollapsible(link, type) {
            // Find the content div for this specific type
            const messageContent = link.closest('.message-content');
            const content = messageContent.querySelector(`.collapsible-content[data-type="${type}"]`);
            
            if (content) {
                const isExpanded = content.classList.contains('expanded');
                
                // Close all other collapsibles in this message
                messageContent.querySelectorAll('.collapsible-content').forEach(c => {
                    c.classList.remove('expanded');
                });
                
                // Toggle this one
                if (!isExpanded) {
                    content.classList.add('expanded');
                    link.style.color = '#0D8B6F';
                } else {
                    link.style.color = '#10A37F';
                }
                
                // Update link text to show state
                if (!isExpanded) {
                    if (type.startsWith('citation')) {
                        link.textContent = 'üìö Hide Citation';
                    } else if (type.startsWith('reasoning')) {
                        link.textContent = 'üí≠ Hide Reasoning';
                    } else if (type.startsWith('attribution')) {
                        link.textContent = 'üîó Hide Attribution';
                    } else if (type.startsWith('source')) {
                        link.textContent = 'üé¨ Hide Source';
                    }
                } else {
                    if (type.startsWith('citation')) {
                        link.textContent = 'üìö Citation';
                    } else if (type.startsWith('reasoning')) {
                        link.textContent = 'üí≠ Reasoning';
                    } else if (type.startsWith('attribution')) {
                        link.textContent = 'üîó Attribution';
                    } else if (type.startsWith('source')) {
                        link.textContent = 'üé¨ Source';
                    }
                }
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function scrollToBottom() {
            const container = document.getElementById('chatContainer');
            container.scrollTop = container.scrollHeight;
        }

        function showTyping(agents) {
            const indicator = document.getElementById('typingIndicator');
            const text = document.getElementById('typingText');
            
            if (agents.length === 1) {
                const agentInfo = getAgentInfo(agents[0]);
                text.textContent = `${agentInfo.name} is thinking...`;
            } else {
                text.textContent = 'Agents are collaborating...';
            }
            
            indicator.style.display = 'flex';
            scrollToBottom();
        }

        function hideTyping() {
            document.getElementById('typingIndicator').style.display = 'none';
        }

        // Socket event listeners
        socket.on('message_received', function(data) {
            renderMessage(data);
        });

        socket.on('typing', function(data) {
            showTyping(data.agents);
        });

        socket.on('agent_response', function(data) {
            console.log('üî• RECEIVED AGENT RESPONSE:', data);
            hideTyping();
            renderMessage(data);
            document.getElementById('sendBtn').disabled = false;
        });

        socket.on('inter_agent_conversation', function(data) {
            if (data.conversation) {
                addInterAgentConversation(data.conversation);
            }
        });

        socket.on('connect', function() {
            console.log('Connected to server');
        });

        socket.on('disconnect', function() {
            console.log('Disconnected from server');
        });
    </script>
</body>
</html>
